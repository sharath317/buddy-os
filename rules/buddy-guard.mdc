---
description: "Buddy Guard - Prevents Buddy from interrupting during flow state"
category: Personal Agent
globs: ["**/*"]
alwaysApply: true
severity: info
---

# ğŸ›¡ï¸ Buddy Guard - Flow State Protection

This rule prevents Buddy from being intrusive during focused work sessions.

## ğŸ¯ Purpose

Buddy should be helpful, not annoying. This guard ensures Buddy:
- Respects your flow state
- Waits for natural pauses
- Doesn't interrupt active coding
- Defers non-urgent suggestions

## ğŸ”’ Protection Rules

### 1. Typing Detection

```
IF user is typing at >40 WPM:
  â†’ Do NOT trigger /buddy
  â†’ Wait for 30-second idle period
  â†’ Then show minimal notification (not full snapshot)
```

### 2. Active Work Detection

```
IF working tree is dirty (uncommitted changes):
  â†’ Buddy enters "Execution Mode"
  â†’ No proactive suggestions
  â†’ Only responds to explicit /buddy calls
```

### 3. Time-Based Suppression

```
IF last Buddy run was <2 hours ago:
  â†’ Skip auto-run
  â†’ User can still call /buddy manually
```

### 4. Context Continuity

```
IF user is mid-conversation (>5 messages in thread):
  â†’ Do NOT interrupt with daily snapshot
  â†’ Defer until new conversation
```

### 5. After-Hours Quiet

```
IF local time is after 6 PM:
  â†’ Do NOT auto-run Buddy
  â†’ Only respond to explicit calls
  â†’ Exception: Urgent signals (CI failure, blocking PR)
```

## ğŸš¨ Exception: Urgent Signals

Even during silent mode, Buddy CAN interrupt for:

| Signal | Reason |
|--------|--------|
| CI Failure | Your build is broken - needs immediate attention |
| Blocking PR | Someone is waiting on you |
| Jira Due Today | Deadline imminent |
| Slack @mention with "urgent" | Explicit urgency |

Format for urgent interruption:

```
âš ï¸ Buddy Interrupt (Urgent)
â”œâ”€ CI Failure in noticket-cursor
â””â”€ Run: pnpm compile to diagnose

[Dismiss] [Show Details]
```

## ğŸ“Š Flow State Indicators

Buddy tracks these signals to detect flow state:

| Indicator | Threshold | Meaning |
|-----------|-----------|---------|
| Typing speed | >40 WPM | Active coding |
| Uncommitted files | >0 | Mid-task |
| Last commit | <30 min | Recently active |
| File switches | <3/min | Deep focus |
| Last Buddy run | <2 hours | Recently planned |

## ğŸ­ Mode Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLOW STATE DETECTION                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Idle (30s+)                                               â”‚
â”‚  â””â”€ Clean tree? â†’ Planning Mode (full Buddy)               â”‚
â”‚  â””â”€ Dirty tree? â†’ Stay silent                              â”‚
â”‚                                                             â”‚
â”‚  Active Typing                                              â”‚
â”‚  â””â”€ Always silent (Execution Mode)                         â”‚
â”‚                                                             â”‚
â”‚  Just Committed                                             â”‚
â”‚  â””â”€ Brief pause â†’ Offer /buddy reflect                     â”‚
â”‚                                                             â”‚
â”‚  Session Start                                              â”‚
â”‚  â””â”€ First message? â†’ Full Buddy snapshot                   â”‚
â”‚  â””â”€ Continuing? â†’ Check last run time                      â”‚
â”‚                                                             â”‚
â”‚  High-Churn File Detected (v2.1)                           â”‚
â”‚  â””â”€ Trigger Drift Mode â†’ Enable stricter checks            â”‚
â”‚  â””â”€ Suggest /snapshot before changes                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš§ Architecture Drift Mode (v2.1)

When Buddy detects you're modifying a high-churn/legacy area:

### Detection Triggers

```
IF file has >50 commits in last 6 months (via churn-map logic):
  â†’ Activate Drift Mode
  â†’ Show warning with Blast Radius
  â†’ Enable stricter linting
  â†’ Pre-load migration guide (if exists)
  â†’ Suggest /snapshot
```

### Drift Mode Warning

```
âš ï¸ DRIFT MODE ACTIVATED
â”œâ”€ File: MainWithBooking.tsx
â”œâ”€ Churn Level: ğŸ”´ Critical (145 commits/6mo)
â”œâ”€ Blast Radius: High (affects 42 files)
â”‚
â”œâ”€ Actions Taken:
â”‚   â”œâ”€ Stricter linting enabled
â”‚   â”œâ”€ Migration guide pre-loaded (if available)
â”‚   â””â”€ /snapshot suggested before changes
â”‚
â””â”€ Consider: /churn-map for full debt analysis
```

### Blast Radius Calculation

| Level | Files Affected | Risk |
|-------|----------------|------|
| ğŸŸ¢ Low | <5 files | Safe to proceed |
| ğŸŸ¡ Medium | 5-20 files | Review carefully |
| ğŸ”´ High | >20 files | Suggest /snapshot first |

## âš™ï¸ Configuration

Users can adjust guard settings in `.cursor/buddy-config.json`:

```json
{
  "flow_protection": {
    "typing_wpm_threshold": 40,
    "idle_seconds_before_interrupt": 30,
    "quiet_hours_start": 18,
    "quiet_hours_end": 8,
    "min_hours_between_auto_runs": 2
  },
  "urgent_overrides": {
    "ci_failure": true,
    "blocking_pr": true,
    "jira_due_today": true,
    "slack_urgent": true
  }
}
```

## ğŸ” Role Permission Enforcement

Before any action, Buddy Guard checks:

```
def enforce_permission(command, role):
    # 1. Check role-permissions.mdc for allowed commands
    if command not in get_allowed_commands(role):
        return block_with_explanation(command, role)

    # 2. Check MCP access
    if command.requires_mcp:
        access = get_mcp_access(role, command.mcp)
        if access == "none":
            return block_no_access(command.mcp, role)
        if command.requires_write and access == "read":
            return block_read_only(command.mcp, role)

    # 3. Check trust level
    required_level = get_trust_level(command)
    role_autonomy = get_role_autonomy(role)

    if required_level > role_autonomy:
        return escalate(command, role)

    return allow(command)
```

## ğŸ›¡ï¸ L4 Action Protection

L4 actions ALWAYS require confirmation, regardless of:
- Role
- YOLO mode
- Time of day

```
L4_ACTIONS = [
    "merge_to_main",
    "jira_status_change",
    "production_deploy",
    "force_push",
    "delete_unmerged_branch"
]

for action in L4_ACTIONS:
    action.confirmation = REQUIRED
    action.yolo_bypass = FALSE
    action.audit = MANDATORY
```

## ğŸ¯ Goal

Buddy should feel like a helpful colleague who:
- Knows when to speak up
- Knows when to stay quiet
- Never interrupts deep work
- Is always available when called
- Never exceeds granted permissions
- Always logs autonomous actions

**The best Buddy interaction is one you barely notice, yet always have the right context.**
